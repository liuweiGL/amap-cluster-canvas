!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self)["amap-cluster-canvas"]={})}(this,function(t){"use strict";function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function o(t,e,n){return e&&i(t.prototype,e),n&&i(t,n),t}function r(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function s(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{},i=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(n).filter(function(t){return Object.getOwnPropertyDescriptor(n,t).enumerable}))),i.forEach(function(e){r(t,e,n[e])})}return t}function a(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var s,a=t[Symbol.iterator]();!(i=(s=a.next()).done)&&(n.push(s.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{i||null==a.return||a.return()}finally{if(o)throw r}}return n}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var u=function(){function t(e){n(this,t),this.layer=null,this.hoverCanvas=null,this.hoverCanvasCtx=null,this.clusterCanvas=null,this.clusterCanvasCxt=null,this.options=e,this.pixelRatio=this.getPixelRatio(),this.init()}return o(t,[{key:"init",value:function(){var t=this.options,e=t.map,n=t.visible,i=t.zIndex,o=t.render,r=document.createElement("div"),s=document.createElement("canvas");s.style.position="absolute";var a=document.createElement("canvas");a.style.position="absolute",r.appendChild(s),r.appendChild(a),this.clusterCanvas=s,this.hoverCanvas=a,this.clusterCanvasCxt=s.getContext("2d"),this.hoverCanvasCtx=a.getContext("2d"),this.layer=new AMap.CustomLayer(r,{map:e,zIndex:i,visible:n,zooms:[1,20]}),this.layer.render=o}},{key:"getPixelRatio",value:function(){return Math.min(2,Math.round(window.devicePixelRatio||1))}},{key:"setCanvasSize",value:function(t,e,n){var i=this.pixelRatio;t.width=e*i,t.height=n*i,t.style.width=e+"px",t.style.height=n+"px"}}]),t}(),l=function(){function t(e,i){n(this,t),this.renderPixel=null,this.points=[e],this.coordinate=e.coordinate,this.averageCenter=i.averageCenter,this.coordinateEngine=i.coordinateEngine}return o(t,[{key:"getCount",value:function(){return this.points.length}},{key:"updateCenter",value:function(){var t=this.averageCenter,e=this.points,n=this.points.length,i=this.coordinate,o=i.x,r=i.y;if(t){var s=e[n-1].coordinate,a=(o*(n-1)+s.x)/n,u=(r*(n-1)+s.y)/n;this.coordinate={x:a,y:u},this.renderPixel=this.coordinateEngine.coordinateToPixel(this)}else{var l=this.points[0];this.coordinate=l.coordinate,this.renderPixel=l.renderPixel}}},{key:"addPoint",value:function(t){this.points.push(t),this.updateCenter()}},{key:"contains",value:function(t){var e=t.coordinate,n=e.x,i=e.y,o=this.coordinate,r=o.x,s=o.y,a=this.coordinateEngine.getGridSize();return n>=r-a&&n<=r+a&&i>=s-a&&i<=s+a}}]),t}(),h=function(){function t(e){n(this,t),this.map=e.map,this.gridSize=e.gridSize}return o(t,[{key:"getGridSize",value:function(){return this.gridSize}},{key:"getRenderData",value:function(t){var e=this,n=[],i=this.map.getBounds();return t.forEach(function(t){if(i.contains(t.position)){var o=e.map.lngLatToContainer(t.position);n.push(s({},t,{coordinate:o,renderPixel:o}))}}),n}},{key:"coordinateToPixel",value:function(t){return t.coordinate}}]),t}();function c(t){var e=a(t,2),n=e[0],i=e[1],o=20037508.34*n/180,r=Math.log(Math.tan((90+i)*Math.PI/360))/(Math.PI/180);return{x:o,y:r=20037508.34*r/180}}function d(t,n){switch(e(n)){case"number":return n;case"string":return"%"===n.trim().substr(-1)?t*(Number.parseFloat(n)/100):Number.parseFloat(n);default:return Number.parseFloat(n)}}function v(t,e){if(!Array.isArray(e))return[0,0];var n=t.width,i=t.height;return[d(n,e[0]),d(i,e[1])]}var f=function(){function t(e){n(this,t),this.map=e.map,this.gridSize=e.gridSize}return o(t,[{key:"getGridSize",value:function(){return this.gridSize*Math.pow(2,18-this.map.getZoom())}},{key:"getRenderData",value:function(t){var e=this,n=[],i=this.getExtendedBounds();return t.forEach(function(t){var o=t.coordinate,r=t.renderPixel;o||(o=c(t.position),r=e.coordinateToPixel(t)),e.contains(i,o)&&n.push(s({},t,{coordinate:o,renderPixel:r}))}),n}},{key:"getExtendedBounds",value:function(){var t=this.getGridSize(),e=this.map.getBounds(),n=e.getSouthWest(),i=e.getNorthEast(),o=c([n.lng,n.lat]),r=c([i.lng,i.lat]);return o.x-=t,o.y-=t,r.x+=t,r.y+=t,[o,r]}},{key:"coordinateToPixel",value:function(t){return this.map.lngLatToContainer(t.position||(e=t.coordinate,n=e.x,i=e.y/20037508.34*180,[n/20037508.34*180,i=180/Math.PI*(2*Math.atan(Math.exp(i*Math.PI/180))-Math.PI/2)]));var e,n,i}},{key:"contains",value:function(t,e){var n=a(t,2),i=n[0],o=n[1],r=e.x,s=e.y;return o.x<=0||r>=i.x&&r<=o.x&&s>=i.y&&s<=o.y}}]),t}(),m=function(){function t(e){n(this,t),this.hoverPoint=null,this.cluster=e,this.map=e.options.map,this.click=e.options.clickHandler,this.mouseout=e.options.mouseoutHandler,this.mouseover=e.options.mouseoverHandler,this.mousemove=e.options.mousemoveHandler,this.zoomOnClick=e.options.zoomOnClick,this.initEvent()}return o(t,[{key:"initEvent",value:function(){this.map.on("click",this.clickHandler.bind(this)),this.map.on("mousemove",this.mousemoveHandler.bind(this)),this.map.on("zoomstart",this.zoomstartHandler.bind(this))}},{key:"clickHandler",value:function(t){var e=t.pixel,n=this.findPoint(e);if(n){var i=this.cluster.getParams(n);this.mouseoutHandler(n),this.zoomOnClick&&i.isCluster&&this.zoomOnClickHandler(n),this.cluster.isFunction(this.click)&&this.click(i)}}},{key:"mousemoveHandler",value:function(t){var e=t.pixel,n=this.hoverPoint,i=this.findPoint(e);n&&!this.constains(n,e)&&this.mouseoutHandler(),i&&n!==i&&this.mouseoverHandler(i),this.cluster.isFunction(this.mousemove)&&this.mousemove(t,i)}},{key:"mouseoverHandler",value:function(t){this.hoverPoint=t;var e=this.cluster.getParams(t);this.cluster.renderHoverPoint(e),this.cluster.isFunction(this.mouseover)&&this.mouseover(e)}},{key:"mouseoutHandler",value:function(){this.hoverPoint=null,this.cluster.clearHoverPoint(),this.cluster.isFunction(this.mouseout)&&this.mouseout(this.cluster.getParams(this.hoverPoint))}},{key:"zoomstartHandler",value:function(){this.mouseoutHandler()}},{key:"zoomOnClickHandler",value:function(t){var e=t.renderPixel,n=e.x,i=e.y,o=new AMap.Pixel(n,i),r=this.map.containerToLngLat(o);this.map.setCenter(r),this.map.zoomIn()}},{key:"findPoint",value:function(t){for(var e=this.cluster.getPoints(),n=e.length,i=0;i<n;i++){var o=e[i];if(this.constains(o,t))return o}return null}},{key:"constains",value:function(t,e){var n=this.cluster.getParams(t),i=a(n.offset,2),o=i[0],r=i[1],s=n.style,u=s.width,l=s.height,h=t.renderPixel,c=h.x,d=h.y,v=e.x,f=e.y;return v>=c+o&&v<=c+u+o&&f>=d+r&&f<=d+l+r}}]),t}(),p={MERCATOR:"MERCATOR",AMAP:"AMAP"},y={width:60,height:69},g={data:null,coordinate:p.AMAP,maxZoom:18,gridSize:60,minClusterSize:2,averageCenter:!0,zoomOnClick:!0,zIndex:120,visible:!0,offset:null,getPosition:function(t){var e=t.location;return e?[e.longitude,e.latitude]:null},render:null,hoverRender:null,clickHandler:null,mouseoutHandler:null,mouseoverHandler:null,mousemoveHandler:null,normalPointStyle:y,clusterPointStyle:y,hoverNormalPointStyle:y,hoverClusterPointStyle:y},P=function(){function t(e){n(this,t),this.data=null,this.points=[],this.renderData=null,this.clusterItems=null,this.options=Object.assign({},g,e),this.options.data=null,this.normalOffset=v(this.options.normalPointStyle,e.offset),this.clusterOffset=v(this.options.clusterPointStyle,e.offset),this.eventEngine=new m(this),this.renderEngine=new u({map:this.options.map,zIndex:this.options.zIndex,visible:this.options.visible,render:this.build.bind(this)}),this.coordinateEngine=this.options.coordinate===p.AMAP?new h(this.options):new f(this.options),this.setData(e.data,!1)}return o(t,[{key:"setData",value:function(t){var e=this,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this.options.getPosition;this.data=[],t&&t.forEach(function(t){t.position=i(t),e.data.push(t)}),n&&this.build()}},{key:"build",value:function(){this.buildCusterItem(),this.updatePoints(),this.render()}},{key:"buildCusterItem",value:function(){var t=this,e={coordinateEngine:this.coordinateEngine,averageCenter:this.options.averageCenter};this.clusterItems=[],this.renderData=this.coordinateEngine.getRenderData(this.data),this.renderData.forEach(function(n){var i=null,o=-1,r=n.coordinate,s=r.x,a=r.y;if(t.clusterItems.forEach(function(t){if(t.contains(n)){var e=t.coordinate,r=e.x,u=e.y,l=Math.pow(s-r,2)+Math.pow(a-u,2);(o<0||o>l)&&(i=t,o=l)}}),i)i.addPoint(n);else{var u=new l(n,e);t.clusterItems.push(u)}})}},{key:"updatePoints",value:function(){var t=this.clusterItems,e=this.options,n=e.map,i=e.minClusterSize,o=e.maxZoom;if(n.getZoom()>=o)this.points=t.reduce(function(t,e){return t.concat(e.points)},[]);else{var r=[];t.forEach(function(t){t.getCount()>=i?r.push(t):r=r.concat(t.points)}),this.points=r}}},{key:"renderLater",value:function(t){this.renderTimer||(this.renderTimer=setTimeout(this.render.bind(this),t||50))}},{key:"render",value:function(){var t=this,e=this.points,n=this.options.render,i=this.renderEngine,o=i.pixelRatio,r=i.clusterCanvasCxt;this.isFunction(n)&&(this.renderTimer&&(clearTimeout(this.renderTimer),this.renderTimer=null),this.clearCluster(),e.forEach(function(i,s){var a=t.getParams(i);a.index=s,n(r,i.renderPixel.x*o,i.renderPixel.y*o,a.style.width,a.style.height,a,e)}))}},{key:"renderHoverPoint",value:function(t){if(this.isFunction(this.options.hoverRender)){var e=t.isCluster,n=t.data.renderPixel,i=n.x,o=n.y,r=this.renderEngine,s=this.renderEngine.hoverCanvasCtx,a=this.options,u=a.hoverRender,l=a.hoverNormalPointStyle,h=a.hoverClusterPointStyle,c=e?h:l,d=c.width,v=c.height,f=r.getPixelRatio();u(s,i*f,o*f,d,v,t)}}},{key:"clearCluster",value:function(){var t=this.renderEngine,e=this.renderEngine.clusterCanvas,n=this.options.map.getSize(),i=n.width,o=n.height;t.setCanvasSize(e,i,o)}},{key:"clearHoverPoint",value:function(){var t=this.renderEngine,e=this.renderEngine.hoverCanvas,n=this.options.map.getSize(),i=n.width,o=n.height;t.setCanvasSize(e,i,o)}},{key:"getPoints",value:function(){return this.points}},{key:"getParams",value:function(t){var e=this.normalOffset,n=this.options.normalPointStyle,i=this.isCluster(t);return i&&(e=this.clusterOffset,n=this.options.clusterPointStyle),{isCluster:i,offset:e,style:n,data:t}}},{key:"isCluster",value:function(t){return t instanceof l}},{key:"isFunction",value:function(t){return"function"==typeof t}}]),t}();t.Coordinate=p,t.default=P,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=amap-cluster-canvas.umd.js.map
